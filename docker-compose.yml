# Vault-integrated version
# Stack: pia
# Deploy with:
#   docker compose -f pia-vault.yaml --env-file .env up -d
networks:
  vault-network:
    external: true
    name: vault-network

services:
  pia-wg-generator:
    container_name: pia-wg-generator
    image: fbeilke/pia-wg-generator:latest
    restart: unless-stopped
    networks:
      - vault-network
    env_file:
      - /shared-configs/env/pia.env
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "
      echo 'üîê Fetching secrets from Vault...' &&
      . /vault-shared/scripts/vault-init-container.sh &&
      fetch_and_export 'secret/data/pia/general' 'PIA_PASS' 'pia_pass' &&
      echo '‚úÖ All secrets fetched successfully!' &&
      echo 'üöÄ Starting service...' &&
      exec /sbin/tini -- /app/docker-entrypoint.sh
      "
    environment:
      VAULT_ADDR: "${VAULT_ADDR}"
      VAULT_TOKEN: "${VAULT_TOKEN}"
      CONFIG_DIR: "/configs"
      DEBUG: "0"
      PIA_USER: "p2259420"
      REGIONS: "de_berlin,br,de-frankfurt,nl_amsterdam,no,sweden,uk"
      UPDATE_INTERVAL: "0 */12 * * *"
    volumes:
      - /mnt/storage/configs/docker-stacks/vault-shared/scripts:/vault-shared/scripts:ro
      - /mnt/storage/downloads/pia-wireguard:/configs
      - /mnt/storage/configs/pia-wireguard/logs:/logs
